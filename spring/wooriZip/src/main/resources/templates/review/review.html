<div th:fragment="reviewBoard(productId, loginUser, reviews, currentPage, totalPages, sort, reviewCount, averageRating, ratingCounts, hasWrittenReview)">
  <div class="review-section my-4">
    <!-- ⭐ 평점 요약 -->
    <div class="mb-4 p-3 border rounded bg-light">
      <h5 class="mb-2">⭐ 평균 평점: <span th:text="${averageRating}">0.0</span> / 5</h5>
      <p class="mb-3">총 리뷰 수: <span th:text="${reviewCount}">0</span>개</p>

      <div th:each="star : ${#numbers.sequence(5,1)}"
           th:with="count=${ratingCounts[star]}, percent=${count != null and reviewCount > 0 ? #numbers.formatDecimal(count * 100.0 / reviewCount, 1, 1) : 0}">
        <div class="d-flex align-items-center mb-2">
          <span th:text="|${star}점|" style="width: 40px;"></span>
          <div class="progress mx-2" style="width: 200px; height: 16px;">
            <div class="progress-bar bg-warning"
                 role="progressbar"
                 th:style="'width:' + percent + '%'"
                 th:text="${count != null ? count + '명' : '0명'}">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 정렬 & 리뷰작성 버튼 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <form method="get" th:action="@{'/products/' + ${productId}}">
        <select name="sort" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="latest" th:selected="${sort == 'latest'}">최신순</option>
          <option value="rating" th:selected="${sort == 'rating'}">평점순</option>
        </select>
        <input type="hidden" name="page" th:value="${currentPage}" />
      </form>

      <div th:if="${loginUser != null and !hasWrittenReview}">
        <form th:action="@{'/review/write'}" method="get">
          <input type="hidden" name="productId" th:value="${productId}" />
          <button type="submit" class="btn btn-sm btn-outline-secondary">리뷰 작성</button>
        </form>
      </div>
    </div>

    <!-- 리뷰 리스트 -->
    <div th:each="review : ${reviews}" class="card mb-3 p-3 border rounded">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-1">
          <div>
            <strong th:text="${review.nickname}">작성자</strong>
            <span class="ms-2 text-warning fw-bold">⭐ <span th:text="${review.rating}">0</span></span>
          </div>
          <small class="text-muted" th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}"></small>
        </div>
        <h5 class="mt-2 fw-bold" th:text="${review.title}">제목</h5>
        <p th:text="${review.content}">내용</p>

        <!-- 이미지 -->
        <div th:if="${review.filePathList != null}" class="d-flex flex-wrap gap-2 mb-2">
          <img th:each="img : ${review.filePathList}"
               th:src="@{${img}}"
               class="border rounded"
               style="width: 120px; object-fit: cover;" />
        </div>

        <!-- 수정/삭제 -->
        <div th:if="${loginUser != null and review.email == loginUser.email}">
          <form th:action="@{'/review/edit/' + ${review.id}}" method="get" class="d-inline">
            <button type="submit" class="btn btn-sm btn-outline-secondary">수정</button>
          </form>
          <form th:action="@{'/review/delete/' + ${review.id}}" method="post" class="d-inline">
            <button type="submit" class="btn btn-sm btn-outline-danger">삭제</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 페이지네이션 -->
    <nav th:if="${totalPages > 1}">
      <ul class="pagination justify-content-center">
        <li th:each="i : ${#numbers.sequence(1, totalPages)}"
            th:classappend="${i == currentPage} ? 'page-item active' : 'page-item'">
          <a class="page-link"
             th:href="@{'/products/' + ${productId} + '?page=' + ${i} + '&sort=' + ${sort}}"
             th:text="${i}">1</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
