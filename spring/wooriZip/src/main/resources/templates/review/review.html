<div th:fragment="reviewboard">
    <style>
        :root {
            --brand-bg: #FFFFFF;
            --brand-text: #4A4947;
            --brand-point-bg: #F9F7F0;
            --brand-point: #B17457;
        }

        .review-container {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        /* í‰ì  ìš”ì•½ */
        .rating-summary {
            background: var(--brand-point-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid #e0e0e0;
        }

        .rating-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--brand-text);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .average-rating {
            color: var(--brand-point);
            font-weight: 600;
        }

        .rating-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rating-bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rating-label {
            min-width: 40px;
            font-weight: 600;
            color: var(--brand-text);
        }

        .progress-container {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: var(--brand-point);
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* ì •ë ¬ ë²„íŠ¼ */
        .sort-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 24px;
        }

        .sort-btn {
            padding: 8px 16px;
            border: 1px solid var(--brand-point);
            border-radius: 6px;
            background: transparent;
            color: var(--brand-point);
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .sort-btn:hover {
            background: var(--brand-point);
            color: #fff;
        }

        .sort-btn.active {
            background: var(--brand-point);
            color: #fff;
        }

        /* ë¦¬ë·° ì‘ì„± ì„¹ì…˜ */
        .write-section {
            background: var(--brand-point-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid #e0e0e0;
        }

        .write-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--brand-text);
            margin-bottom: 16px;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--brand-point);
            color: #fff;
        }

        .btn-primary:hover {
            background: #8d5a41;
        }

        .btn-secondary {
            background: #6c757d;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: #fff;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-outline-primary {
            background: transparent;
            color: var(--brand-point);
            border: 1px solid var(--brand-point);
        }

        .btn-outline-primary:hover {
            background: var(--brand-point);
            color: #fff;
        }

        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 1px solid #6c757d;
        }

        .btn-outline-secondary:hover {
            background: #6c757d;
            color: #fff;
        }

        .btn-outline-danger {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .btn-outline-danger:hover {
            background: #dc3545;
            color: #fff;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-container {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 16px;
            border: 1px solid #e0e0e0;
        }

        .form-label {
            font-weight: 600;
            color: var(--brand-text);
            margin-bottom: 8px;
            display: block;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--brand-point);
        }

        .rating-input {
            width: 80px !important;
        }

        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ */
        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .image-upload-area:hover {
            border-color: var(--brand-point);
            background: var(--brand-point-bg);
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 6px;
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(220, 53, 69, 0.9);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        /* ë¦¬ë·° ì¹´ë“œ */
        .review-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }

        .review-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .review-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .review-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .rating-score {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .rating-score.high {
            color: #28a745;
        }

        .rating-score.medium {
            color: #0d6efd;
        }

        .rating-score.low {
            color: #dc3545;
        }

        .review-author {
            color: #666;
            font-size: 0.9rem;
        }

        .review-date {
            color: #999;
            font-size: 0.8rem;
        }

        .review-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--brand-text);
            margin-bottom: 12px;
        }

        .review-content {
            color: var(--brand-text);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .review-images {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .review-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }

        .review-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        /* ìˆ˜ì • í¼ */
        .edit-form {
            background: var(--brand-point-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 16px;
        }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 32px;
        }

        .page-item {
            list-style: none;
        }

        .page-link {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: var(--brand-text);
            text-decoration: none;
            transition: all 0.2s;
        }

        .page-link:hover {
            background: var(--brand-point-bg);
            border-color: var(--brand-point);
        }

        .page-item.active .page-link {
            background: var(--brand-point);
            color: #fff;
            border-color: var(--brand-point);
        }

        .page-item.disabled .page-link {
            color: #ccc;
            cursor: not-allowed;
        }

        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .review-container {
                padding: 16px;
            }

            .rating-summary {
                padding: 16px;
            }

            .sort-section {
                justify-content: center;
            }

            .review-card {
                padding: 16px;
            }

            .review-header {
                flex-direction: column;
                gap: 12px;
            }

            .review-images {
                justify-content: center;
            }

            .review-image {
                width: 100px;
                height: 100px;
            }
        }
    </style>

    <div class="review-container">
        <!-- í‰ì  ìš”ì•½ -->
        <div class="rating-summary" th:if="${reviewPage != null and reviewPage.totalElements > 0}">
            <h5 class="rating-title">
                â­ í‰ê·  í‰ì  : <span class="average-rating"
                                th:text="${#numbers.formatDecimal(averageRating != null ? averageRating : 0.0, 1, 1)}">0.0</span> / 5
            </h5>
            <div class="rating-bars">
                <div th:each="i : ${#numbers.sequence(5, 1)}" class="rating-bar-item">
                    <span class="rating-label" th:text="|${i}ì :|"></span>
                    <div class="progress-container">
                        <div class="progress-bar" role="progressbar"
                             th:with="count=${ratingSummary != null and ratingSummary.containsKey(i) ? ratingSummary.get(i) : 0}, total=${reviewPage.totalElements}"
                             th:style="'width: ' + (${total > 0 ? count * 100 / total : 0}) + '%'"
                             th:text="${count}"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¦¬ë·°ê°€ ì—†ì„ ë•Œ -->
        <div class="rating-summary" th:if="${reviewPage == null or reviewPage.totalElements == 0}">
            <h5 class="rating-title">â­ í‰ê·  í‰ì : 0.0 / 5</h5>
            <p style="color: #666; margin: 0;">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- ì •ë ¬ íƒ­: ìš°ì¸¡ ìƒë‹¨ -->
        <div class="sort-section">
            <a th:href="@{|?sort=latest&page=1|}" class="sort-btn"
               th:classappend="${sort == 'latest'} ? 'active'">ìµœì‹ ìˆœ</a>
            <a th:href="@{|?sort=rating&page=1|}" class="sort-btn"
               th:classappend="${sort == 'rating'} ? 'active'">í‰ì ìˆœ</a>
        </div>

        <!-- ë¦¬ë·° ì‘ì„± ë²„íŠ¼ ë° í¼ -->
        <div class="write-section">
            <!-- ë¦¬ë·° ìˆ˜ì • ëª¨ë“œ -->
            <div th:if="${review != null}">
                <h4 class="write-title">âœï¸ ë¦¬ë·° ìˆ˜ì •</h4>
                <form id="reviewForm" th:action="@{/review/update/{id}(id=${review.id})}" method="post"
                      enctype="multipart/form-data" class="form-container">
                    <input type="hidden" name="productId" th:value="${review.product.id}"/>

                    <div style="margin-bottom: 16px;">
                        <label class="form-label">ì œëª©:</label>
                        <input type="text" name="title" class="form-control" th:value="${review.title}" required>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label class="form-label">í‰ì </label>
                        <input type="number" name="rating" th:value="${review.rating}" min="1" max="5" 
                               class="form-control rating-input" required/>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label class="form-label">ë‚´ìš©:</label>
                        <textarea name="content" class="form-control" rows="4" required th:text="${review.content}"></textarea>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label class="form-label">ì´ë¯¸ì§€ ì²¨ë¶€ (ìµœëŒ€ 4ì¥):</label>
                        <div class="image-upload-area" onclick="document.getElementById('reviewImageInput').click()">
                            <div style="font-size: 2rem; color: var(--brand-point); margin-bottom: 8px;">ğŸ“</div>
                            <div>í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                        </div>
                        <input type="file" name="files" id="reviewImageInput" multiple accept="image/*"
                               class="form-control" style="display: none;">
                        <!-- ê¸°ì¡´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                        <div id="existingImagesContainer" class="preview-container">
                            <th:block th:if="${review.filePaths != null and review.filePaths != ''}">
                                <div th:each="path, stat : ${#strings.arraySplit(review.filePaths, ',')}"
                                     class="preview-item">
                                    <img th:src="${path}" class="review-image">
                                    <button type="button"
                                            class="delete-btn delete-existing-image"
                                            th:data-path="${path}">Ã—</button>
                                    <input type="hidden" name="deleteImages" th:value="${path}" disabled>
                                </div>
                            </th:block>
                        </div>
                        <!-- ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                        <div id="reviewPreviewContainer" class="preview-container"></div>
                    </div>

                    <button type="submit" class="btn btn-success">ìˆ˜ì •</button>
                    <a th:href="@{/products/{id}(id=${review.product.id})}" class="btn btn-secondary">ì·¨ì†Œ</a>
                </form>
            </div>

            <!-- ë¦¬ë·° ì‘ì„± ëª¨ë“œ -->
            <div th:if="${review == null and loginUser != null and !hasWritten and hasPurchased}">
                <button class="btn btn-primary" onclick="toggleReviewForm()">âœï¸ ë¦¬ë·° ì‘ì„±</button>

                <form id="reviewForm" th:action="@{/review/create}" method="post" enctype="multipart/form-data"
                      class="form-container" style="display: none;">
                    <input type="hidden" name="productId" th:value="${productId}"/>

                    <div style="margin-bottom: 16px;">
                        <label class="form-label">ì œëª©:</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label class="form-label">í‰ì </label>
                        <input type="number" name="rating" id="createRating" value="1" min="1" max="5"
                               class="form-control rating-input" required/>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label class="form-label">ë‚´ìš©:</label>
                        <textarea name="content" class="form-control" rows="4" required></textarea>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label class="form-label">ì´ë¯¸ì§€ ì²¨ë¶€ (ìµœëŒ€ 4ì¥):</label>
                        <div class="image-upload-area" onclick="document.getElementById('createReviewImageInput').click()">
                            <div style="font-size: 2rem; color: var(--brand-point); margin-bottom: 8px;">ğŸ“</div>
                            <div>í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                        </div>
                        <input type="file" name="files" id="createReviewImageInput" multiple accept="image/*"
                               class="form-control" style="display: none;">
                        <div id="createReviewPreviewContainer" class="preview-container"></div>
                    </div>

                    <button type="submit" class="btn btn-success">ë“±ë¡</button>
                </form>
            </div>

            <!-- êµ¬ë§¤í•˜ì§€ ì•Šì€ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ -->
            <div th:if="${review == null and loginUser != null and !hasWritten and !hasPurchased}" class="alert alert-info">
                ğŸ’¡ ì´ ìƒí’ˆì„ êµ¬ë§¤í•˜ì‹  í›„ì— ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <!-- êµ¬ë§¤ í•„ìš” ì—ëŸ¬ ë©”ì‹œì§€ -->
            <div th:if="${param.error == 'purchase_required'}" class="alert alert-warning">
                âš ï¸ ì´ ìƒí’ˆì„ êµ¬ë§¤í•˜ì‹  í›„ì— ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ì -->
            <div th:if="${review == null and loginUser == null}">
                <a th:href="@{/user/login}" class="btn btn-primary">âœï¸ ë¦¬ë·° ì‘ì„±</a>
                <small style="color: #666; display: block; margin-top: 8px;">ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</small>
            </div>

            <!-- ì´ë¯¸ ì‘ì„±í•œ ì‚¬ìš©ì -->
            <div th:if="${review == null and loginUser != null and hasWritten}">
                <button class="btn btn-secondary" disabled>ì´ë¯¸ ë¦¬ë·°ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤</button>
                <small style="color: #666; display: block; margin-top: 8px;">ìƒí’ˆë‹¹ 1ê°œì˜ ë¦¬ë·°ë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
            </div>
        </div>

        <!-- ë¦¬ë·° ëª©ë¡ -->
        <div>
            <div th:each="review : ${reviewPage.content}" class="review-card" th:id="'review-' + ${review.id}">
                <div class="review-header">
                    <div class="review-meta">
                        <div class="review-rating">
                            <span class="rating-score" 
                                  th:classappend="${review.rating >= 4} ? 'high' : (${review.rating >= 3} ? 'medium' : 'low')"
                                  th:text="${review.rating}">5</span>ì 
                        </div>
                        <div class="review-author" th:text="'ì‘ì„±ì: ' + ${review.nickname}">ì‘ì„±ì</div>
                        <div class="review-date" th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</div>
                    </div>
                </div>
                
                <h5 class="review-title" th:text="${review.title}"></h5>
                <p class="review-content" th:text="${review.content}"></p>
                
                <div th:if="${review.filePathList != null and !review.filePathList.isEmpty()}" class="review-images">
                    <img th:each="img : ${review.filePathList}" th:src="${img}"
                         class="review-image" alt="ë¦¬ë·° ì´ë¯¸ì§€">
                </div>
                
                <div class="review-actions" th:if="${loginUser != null and loginUser.email == review.email}">
                    <button class="btn btn-sm btn-outline-secondary"
                            th:onclick="'toggleReviewEditForm(' + ${review.id} + ')'">âœï¸ ìˆ˜ì •
                    </button>
                    <form th:action="@{/review/delete/{id}(id=${review.id})}" method="post" style="display:inline;">
                        <input type="hidden" name="productId" th:value="${productId}"/>
                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </form>

                    <!-- ë¦¬ë·° ìˆ˜ì • í¼ -->
                    <div th:id="'reviewEditForm_' + ${review.id}" class="edit-form" style="display: none;">
                        <form th:action="@{/review/update/{id}(id=${review.id})}" method="post"
                              enctype="multipart/form-data" class="review-form">
                            <input type="hidden" name="productId" th:value="${productId}"/>

                            <div style="margin-bottom: 16px;">
                                <label class="form-label">ì œëª©:</label>
                                <input type="text" name="title" class="form-control" th:value="${review.title}"
                                       required>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label class="form-label">í‰ì </label>
                                <input type="number" name="rating" th:value="${review.rating}" min="1" max="5"
                                       class="form-control rating-input" required/>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label class="form-label">ë‚´ìš©:</label>
                                <textarea name="content" class="form-control" rows="4" required
                                          th:text="${review.content}"></textarea>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label class="form-label">ì´ë¯¸ì§€ ì²¨ë¶€ (ìµœëŒ€ 4ì¥):</label>
                                <div class="image-upload-area" onclick="document.getElementById('editReviewImageInput_' + ${review.id}).click()">
                                    <div style="font-size: 2rem; color: var(--brand-point); margin-bottom: 8px;">ğŸ“</div>
                                    <div>í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                                </div>
                                <input type="file" name="files" th:id="'editReviewImageInput_' + ${review.id}" class="review-image-input form-control" multiple
                                       accept="image/*" style="display: none;">

                                <!-- ê¸°ì¡´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                                <div class="existing-images-container preview-container">
                                    <th:block th:if="${review.filePathList != null and !review.filePathList.isEmpty()}">
                                        <div th:each="path : ${review.filePathList}"
                                             class="preview-item">
                                            <img th:src="${path}" class="review-image">
                                            <button type="button"
                                                    class="delete-btn delete-existing-image"
                                                    th:data-path="${path}">Ã—</button>
                                            <input type="hidden" name="deleteImages" th:value="${path}" disabled>
                                        </div>
                                    </th:block>
                                </div>

                                <!-- ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                                <div class="review-preview-container preview-container"></div>
                            </div>

                            <button type="submit" class="btn btn-success">ìˆ˜ì •</button>
                            <button type="button" class="btn btn-secondary"
                                    th:onclick="'hideReviewEditForm(' + ${review.id} + ')'">ì·¨ì†Œ
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="pagination" th:if="${reviewPage != null and reviewPage.totalPages > 0}">
            <ul style="list-style: none; display: flex; gap: 8px; margin: 0; padding: 0;">
                <li th:classappend="${reviewPage.first} ? 'disabled'">
                    <a class="page-link" th:href="@{|?sort=${sort}&page=${reviewPage.number}|}">ì´ì „</a>
                </li>
                <li th:each="i : ${#numbers.sequence(1, reviewPage.totalPages)}"
                    th:if="${reviewPage.totalPages > 0}"
                    th:classappend="${i == reviewPage.number + 1} ? 'active'">
                    <a class="page-link" th:href="@{|?sort=${sort}&page=${i - 1}|}" th:text="${i}"></a>
                </li>
                <li th:classappend="${reviewPage.last} ? 'disabled'">
                    <a class="page-link" th:href="@{|?sort=${sort}&page=${reviewPage.number + 2}|}">ë‹¤ìŒ</a>
                </li>
            </ul>
        </div>
    </div>
</div>