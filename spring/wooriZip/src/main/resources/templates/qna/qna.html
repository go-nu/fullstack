<div th:fragment="qnaboard">
  <!-- Q&A 제목 및 작성 버튼 -->
  <div class="mb-4">
    <h4>Q&A (<span th:text="${qnaTotal}"></span>)</h4>

    <!-- 로그인 사용자만 작성 가능 -->
    <div th:if="${loginUser != null}">
      <button class="btn btn-primary mb-3" onclick="toggleQnaForm()">문의 작성</button>
    </div>

    <!-- 문의 작성 폼 -->
    <div id="qnaFormWrapper" class="card p-3 mb-4" style="display: none;">
      <form th:action="@{/qna/create}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="productId" th:value="${product.id}" />

        <div class="mb-2">
          <label>제목</label>
          <input type="text" name="title" class="form-control" required />
        </div>

        <div class="mb-2">
          <label>내용</label>
          <textarea name="content" class="form-control" rows="3" required></textarea>
        </div>

        <div class="mb-2">
          <label>이미지 첨부 (최대 4장)</label>
          <input type="file" name="files" multiple accept="image/*"
                 class="form-control"
                 onchange="previewImages(this, 'qnaPreview')" />
        </div>

        <div id="qnaPreview" class="mb-2 d-flex flex-wrap gap-2"></div>

        <button type="submit" class="btn btn-success">등록</button>
      </form>
    </div>
  </div>

  <!-- Q&A 리스트 -->
  <div th:each="dto : ${qnaList}" class="border rounded p-3 mb-3">
    <!-- 질문 영역 -->
    <div>
      <strong th:text="${dto.title}">제목</strong>
      <p th:text="${dto.content}">내용</p>
      <small class="text-muted"
             th:text="${dto.nickname + ' | ' + #temporals.format(dto.createdDate, 'yyyy-MM-dd HH:mm')}">작성자</small>

      <!-- 이미지 출력 -->
      <div th:if="${dto.filePathList != null}" class="mt-2 d-flex flex-wrap gap-2">
        <img th:each="path : ${dto.filePathList}"
             th:src="@{'/uploads/' + ${path}}"
             class="img-thumbnail"
             style="max-height: 150px;" />
      </div>

      <!-- 본인만 수정/삭제 -->
      <div th:if="${loginUser != null and loginUser.email == dto.email}" class="mt-2">
        <form th:action="@{'/qna/edit/' + ${dto.id}}" method="get" style="display:inline;">
          <button class="btn btn-sm btn-outline-primary">수정</button>
        </form>
        <form th:action="@{'/qna/delete/' + ${dto.id}}" method="post" style="display:inline;">
          <button class="btn btn-sm btn-outline-danger">삭제</button>
        </form>
      </div>
    </div>

    <!-- 답변 영역 (관리자) -->
    <div th:if="${dto.answerDto != null}" class="border-top pt-2 mt-2">
      <strong>답변</strong>
      <p th:text="${dto.answerDto.content}">답변내용</p>
      <small class="text-muted"
             th:text="${#temporals.format(dto.answerDto.createdDate, 'yyyy-MM-dd HH:mm')}">답변일시</small>

      <!-- 관리자만 수정/삭제 -->
      <div th:if="${loginUser != null and loginUser.role == 'ADMIN'}" class="mt-2">
        <form th:action="@{'/qna/answer/update/' + ${dto.answerDto.id}}" method="post" style="display:inline;">
          <input type="hidden" name="content" th:value="${dto.answerDto.content}" />
          <input type="hidden" name="productId" th:value="${product.id}" />
          <button class="btn btn-sm btn-outline-primary">수정</button>
        </form>
        <form th:action="@{'/qna/answer/delete/' + ${dto.answerDto.id}}" method="post" style="display:inline;">
          <input type="hidden" name="productId" th:value="${product.id}" />
          <button class="btn btn-sm btn-outline-danger">삭제</button>
        </form>
      </div>
    </div>
  </div>

  <!-- 페이지네이션 -->
  <nav th:if="${qnaList.size() > 0}" class="mt-4">
    <ul class="pagination justify-content-center">
      <li class="page-item" th:classappend="${qnaPage == 1} ? 'disabled'">
        <a class="page-link"
           th:href="@{'/products/' + ${product.id} + '?qnaPage=' + (${qnaPage - 1})}">이전</a>
      </li>
      <li class="page-item"
          th:each="i : ${#numbers.sequence(1, (qnaTotal / 5.0).ceil().intValue())}"
          th:classappend="${i == qnaPage} ? 'active'">
        <a class="page-link"
           th:href="@{'/products/' + ${product.id} + '?qnaPage=' + ${i}}"
           th:text="${i}"></a>
      </li>
      <li class="page-item"
          th:classappend="${qnaPage >= (qnaTotal / 5.0).ceil().intValue()} ? 'disabled'">
        <a class="page-link"
           th:href="@{'/products/' + ${product.id} + '?qnaPage=' + (${qnaPage + 1})}">다음</a>
      </li>
    </ul>
  </nav>
</div>

<!-- 스크립트 -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    window.toggleQnaForm = function () {
      const form = document.getElementById('qnaFormWrapper');
      if (form) {
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
      }
    };

    window.previewImages = function (input, previewId) {
      const preview = document.getElementById(previewId);
      preview.innerHTML = '';

      if (input.files.length > 4) {
        alert("이미지는 최대 4장까지 첨부할 수 있습니다.");
        input.value = '';
        return;
      }

      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'img-thumbnail me-2';
          img.style.maxHeight = '100px';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    };
  });
</script>
