<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>상품 상세</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Stardos+Stencil:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div>
    <h2 th:text="${product.name}">상품 이름</h2>
    <p th:text="${product.description}">상품 설명</p>

    <!-- 이미지 여러 장 지원 (썸네일/리스트) -->
    <div th:if="${product.images != null && #lists.size(product.images) > 0}">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <img th:each="img : ${product.images}" th:src="${img.imageUrl}" alt="상품 이미지" width="200"
                 style="border:1px solid #ccc; border-radius:8px;"/>
        </div>
    </div>
    <div th:if="${product.images == null || #lists.size(product.images) == 0}">
        <p>이미지가 없습니다.</p>
    </div>

    <!-- 옵션/모델 셀렉트 박스 -->
    <h4>모델/옵션 선택</h4>
    <select id="modelSelect" class="form-select" style="max-width:300px;">
        <option value="">옵션을 선택하세요</option>
        <option th:each="model : ${product.productModels}"
                th:value="${model.id}"
                th:data-price="${model.price}"
                th:data-stock="${model.prStock}"
                th:text="|${model.productModelSelect} / ${#numbers.formatInteger(model.price, 3, 'COMMA')}원 / 재고:${model.prStock}|">
        </option>
    </select>
    <div id="modelInfo" style="margin-top:10px;"></div>

    <!-- 찜/장바구니/구매 Form -->
    <form th:action="@{/wishlist/toggle}" method="post" id="productForm">
        <input type="hidden" id="productId" name="productId" th:value="${product.id}" />
        <input type="hidden" id="actionType" name="actionType" value="cart" />
        <button type="submit" th:text="${product.liked} ? '찜 취소' : '찜하기'"></button>

        <div>
            <div>수량</div>
            <input type="number" name="count" id="count" value="1" min="1"/>
        </div>

        <div>
            <button type="button" onclick="submitForm('cart')">장바구니 추가</button>
            <button type="button" onclick="submitForm('buy')">구매하기</button>
        </div>
    </form>

    <div>
        <div>
            <input type="hidden" id="price" name="price" />
            <span id="selectedPrice">0</span>원
        </div>
        <div>
            <h5>결제 금액</h5>
            <h3 name="totalPrice" id="totalPrice"></h3>
        </div>
    </div>
    <!-- 수정/삭제 버튼: 작성자만 보이게 -->
    <div th:if="${loginUser != null and product.writerId == loginUser.id}">
        <form th:action="@{'/products/' + ${product.id} + '/edit'}" method="get" style="display:inline;">
            <button type="submit">수정</button>
        </form>
        <form th:action="@{'/products/' + ${product.id} + '/delete'}" method="post" style="display:inline;">
            <button type="submit">삭제</button>
        </form>
    </div>

    <!-- 🔙 목록으로 돌아가기 (항상 표시) -->
    <div style="margin-top: 20px;">
        <a th:href="@{/products}">
            <button type="button">목록으로 돌아가기</button>
        </a>
    </div>
</div>

<!-- 리뷰/QnA 탭 삽입 영역 -->
<div id="tab-section-placeholder"></div>

<div class="mt-5">
    <!-- 탭 메뉴 -->
    <div class="tab-menu d-flex mb-3 border-bottom">
        <button class="btn btn-link me-3 tab-button active" data-target="review-section">리뷰</button>
        <button class="btn btn-link tab-button" data-target="qna-section">Q&A</button>
    </div>

    <!-- 리뷰 영역 -->
    <div id="review-section" class="tab-content-section">
        <div th:replace="~{review/review :: reviewboard}"></div>
    </div>

    <!-- Qna 영역 -->
    <div id="qna-section" class="tab-content-section" style="display: none;">
        <div  id="qna-content" th:replace="~{qna/qna :: qnaboard}"></div>
    </div>
</div>

<div th:replace="~{index/footer :: footer}"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/js/product/detail.js" defer></script>
<script>
    // 옵션 선택 시 가격/재고 표시 및 결제 금액 동적 계산
    document.addEventListener('DOMContentLoaded', function() {
        const modelSelect = document.getElementById('modelSelect');
        const selectedPriceSpan = document.getElementById('selectedPrice');
        const countInput = document.getElementById('count');
        const totalPrice = document.getElementById('totalPrice');

        function updatePriceAndTotal() {
            const selected = modelSelect.selectedOptions[0];
            let price = 0;
            if(selected && selected.dataset.price) {
                price = parseInt(selected.dataset.price);
                selectedPriceSpan.innerText = price.toLocaleString();
                document.getElementById('price').value = price;
            } else {
                selectedPriceSpan.innerText = '0';
            }
            const count = parseInt(countInput.value) || 1;
            totalPrice.innerText = (price * count).toLocaleString() + '원';
        }
        modelSelect.addEventListener('change', updatePriceAndTotal);
        countInput.addEventListener('input', updatePriceAndTotal);
        // 최초 로딩 시 결제 금액 표시
        updatePriceAndTotal();
    });
</script>
<script src="/js/review/review.js" defer></script>
<script src="/js/qna/qna.js" defer></script>
</body>
</html>
