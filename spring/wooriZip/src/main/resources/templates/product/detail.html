<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ìƒí’ˆ ìƒì„¸</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Stardos+Stencil:wght@400;700&display=swap" rel="stylesheet">
<!--    <link rel="stylesheet" th:href="@{/css/style.css}">-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div>
    <h2 th:text="${product.name}">ìƒí’ˆ ì´ë¦„</h2>
    <p th:text="${product.description}">ìƒí’ˆ ì„¤ëª…</p>

    <div th:each="img : ${product.images}">
        <img th:src="${img.imageUrl}" alt="ìƒí’ˆ ì´ë¯¸ì§€" width="300"/>
    </div>

    <h4>ëª¨ë¸/ì˜µì…˜</h4>
    <ul>
        <li th:each="model : ${product.productModels}">
            ëª¨ë¸: <span th:text="${model.productModelSelect}"></span>,
            ì¬ê³ : <span th:text="${model.prStock}"></span>
        </li>
    </ul>

    <!-- ì°œí•˜ê¸° ë²„íŠ¼ -->
    <form th:action="@{/wishlist/toggle}" method="post" id="productForm">
        <input type="hidden" id="productId" name="productId" th:value="${product.id}" />
        <input type="hidden" id="actionType" name="actionType" value="cart" />
        <button type="submit" th:text="${product.liked} ? 'ì°œ ì·¨ì†Œ' : 'ì°œí•˜ê¸°'"></button>
        <div>
            <button type="button" onclick="submitForm('cart')">ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€</button>
            <button type="button" onclick="submitForm('buy')">êµ¬ë§¤í•˜ê¸°</button>
        </div>
    </form>

    <!-- ë””ë²„ê¹…ìš© -->
<!--    <p>ì‘ì„±ì ID: <span th:text="${product.writerId}">ì‘ì„±ì ID</span></p>
    <p>ë¡œê·¸ì¸ ìœ ì € ID: <span th:text="${loginUser?.id}">ë¡œê·¸ì¸ ID</span></p>-->

    <div>
        <div>
            <input type="hidden" id="price" name="price" th:value="${product.price}" />
            <span th:text="${product.price}"></span>ì›
        </div>
        <div>
            <div>ìˆ˜ëŸ‰</div>
            <input type="number" name="count" id="count" value="1" min="1"/>
        </div>
    </div>
    <div>
        <h5>ê²°ì œ ê¸ˆì•¡</h5>
        <h3 name="totalPrice" id="totalPrice"></h3>
    </div>


    <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼: ì‘ì„±ìë§Œ ë³´ì´ê²Œ -->
    <div th:if="${loginUser != null and product.writerId == loginUser.id}">
        <form th:action="@{'/products/' + ${product.id} + '/edit'}" method="get" style="display:inline;">
            <button type="submit">ìˆ˜ì •</button>
        </form>
        <form th:action="@{'/products/' + ${product.id} + '/delete'}" method="post" style="display:inline;">
            <button type="submit">ì‚­ì œ</button>
        </form>
    </div>

    <!-- ğŸ”™ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° (í•­ìƒ í‘œì‹œ) -->
    <div style="margin-top: 20px;">
        <a th:href="@{/products}">
            <button type="button">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </a>
    </div>
</div>

<!-- ë¦¬ë·°/QnA íƒ­ ì‚½ì… ì˜ì—­ -->
<div class="mt-5">
    <!-- íƒ­ ë©”ë‰´ -->
    <div class="tab-menu d-flex mb-3 border-bottom">
        <button class="btn btn-link me-3 tab-button active" data-target="review-section">ë¦¬ë·°</button>
        <button class="btn btn-link tab-button" data-target="qna-section">Q&A</button>
    </div>

    <!-- ë¦¬ë·° ì˜ì—­ -->
    <div id="review-section" class="tab-content-section">
        <div th:replace="~{review/review :: reviewboard}"></div>
    </div>

    <!-- Qna ì˜ì—­ -->
    <div id="qna-section" class="tab-content-section" style="display: none;">
        <div th:replace="~{qna/qna :: qnaboard}"></div>
    </div>
</div>

<script>
    $(function() {
        calculateTotalPrice();
        // countê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í•¨ìˆ˜ ì‹¤í–‰
        $('#count').change(function(){
            calculateTotalPrice();
        });
    });

    function calculateTotalPrice(){
        var count = parseInt($('#count').val());
        var price = parseInt($('#price').val());
        if (!isNaN(count) && !isNaN(price)) {
            var totalPrice = count * price;
            $('#totalPrice').html(totalPrice + 'ì›');
        } else {
            $('#totalPrice').html('ê°€ê²© ê³„ì‚° ì˜¤ë¥˜');
        }
    }
</script>
<script>
    // DOMì´ ë¡œë“œë˜ë©´ submitForm í•¨ìˆ˜ ì •ì˜
    document.addEventListener("DOMContentLoaded", function() {
        window.submitForm = function(action) {
            const form = document.getElementById('productForm');
            const productId = document.getElementById('productId').value;
            if(action === 'cart') {
                form.action = "/cart/add";  // ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ URL
                document.getElementById('actionType').value = 'cart';  // actionType ê°’ì„ cartë¡œ ì„¤ì •
            } else if(action === 'buy') {
                form.action = "/order/now";  // êµ¬ë§¤í•˜ê¸° URL
                document.getElementById('actionType').value = 'buy';  // actionType ê°’ì„ buyë¡œ ì„¤ì •
            }
            form.submit();  // POST ë°©ì‹ìœ¼ë¡œ í¼ ì „ì†¡
        };
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // íƒ­ ì „í™˜ ìŠ¤í¬ë¦½íŠ¸ (ê¸°ì¡´)
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const target = this.getAttribute('data-target');
                document.querySelectorAll('.tab-content-section').forEach(section => {
                    section.style.display = section.id === target ? 'block' : 'none';
                });
            });
        });

        // QnA í† ê¸€ í•¨ìˆ˜
        window.toggleQnaForm = function () {
            const form = document.getElementById('qnaFormWrapper');
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        };

        // ë¦¬ë·° í† ê¸€ í•¨ìˆ˜
        window.toggleReviewForm = function () {
            const form = document.getElementById("reviewForm");
            if (form) {
                form.classList.toggle("d-none");
            }
        };

        // í†µí•© ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ (QnAìš©)
        window.previewImages = function (input, previewId) {
            handleImagePreview(input, previewId, 'img-thumbnail me-2', '100px');
        };

        // ë¦¬ë·° ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
        window.handleReviewImagePreview = function(input) {
            const preview = document.getElementById('reviewPreviewContainer');
            preview.innerHTML = '';

            if (input.files.length > 4) {
                alert("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 4ì¥ê¹Œì§€ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                input.value = '';
                return;
            }

            Array.from(input.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const box = document.createElement('div');
                    box.className = 'img-box';
                    box.style.display = 'inline-block';
                    box.style.margin = '10px';
                    box.style.position = 'relative';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '150px';
                    img.style.height = 'auto';
                    img.style.border = '1px solid #ccc';
                    img.style.borderRadius = '12px';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerText = 'X';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = '5px';
                    deleteBtn.style.right = '5px';
                    deleteBtn.style.background = 'red';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.borderRadius = '50%';
                    deleteBtn.style.width = '20px';
                    deleteBtn.style.height = '20px';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.onclick = function() {
                        // íŒŒì¼ ì‚­ì œë¥¼ ìœ„í•´ inputì˜ filesë¥¼ ì¡°ì‘
                        const dt = new DataTransfer();
                        const files = Array.from(input.files);
                        files.splice(index, 1);
                        files.forEach(file => dt.items.add(file));
                        input.files = dt.files;

                        // ë¯¸ë¦¬ë³´ê¸°ì—ì„œë„ ì œê±°
                        box.remove();
                    };

                    box.appendChild(img);
                    box.appendChild(deleteBtn);
                    preview.appendChild(box);
                };
                reader.readAsDataURL(file);
            });
        };

        // QnA ì´ë¯¸ì§€ ì²¨ë¶€ ê¸°ëŠ¥ (ì¸í…Œë¦¬ì–´ ê²Œì‹œíŒê³¼ ë™ì¼í•œ ë°©ì‹)
        let qnaSelectedFiles = [];

        const qnaImageInput = document.getElementById('qnaImageInput');
        const qnaPreviewContainer = document.getElementById('qnaPreviewContainer');

        if (qnaImageInput && qnaPreviewContainer) {
            qnaImageInput.addEventListener('change', function () {
                const newFiles = Array.from(this.files);

                if (qnaSelectedFiles.length + newFiles.length > 4) {
                    alert("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 4ì¥ê¹Œì§€ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    return;
                }

                newFiles.forEach(file => {
                    qnaSelectedFiles.push(file);

                    const reader = new FileReader();
                    reader.onload = e => {
                        const box = document.createElement('div');
                        box.className = 'img-box';
                        box.style.display = 'inline-block';
                        box.style.margin = '10px';
                        box.style.position = 'relative';

                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '150px';
                        img.style.height = 'auto';
                        img.style.border = '1px solid #ccc';
                        img.style.borderRadius = '12px';

                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerText = 'X';
                        deleteBtn.style.position = 'absolute';
                        deleteBtn.style.top = '5px';
                        deleteBtn.style.right = '5px';
                        deleteBtn.style.background = 'red';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.border = 'none';
                        deleteBtn.style.borderRadius = '50%';
                        deleteBtn.style.width = '20px';
                        deleteBtn.style.height = '20px';
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.onclick = function() {
                            const index = qnaSelectedFiles.indexOf(file);
                            if (index > -1) {
                                qnaSelectedFiles.splice(index, 1);
                            }
                            box.remove();
                        };

                        box.appendChild(img);
                        box.appendChild(deleteBtn);
                        qnaPreviewContainer.appendChild(box);
                    };
                    reader.readAsDataURL(file);
                });

                this.value = '';
            });
        }

        // QnA í¼ ì œì¶œ ì‹œ íŒŒì¼ ì¶”ê°€
        const qnaForm = document.querySelector('form[th\\:action*="/qna/create"]');
        if (qnaForm) {
            qnaForm.addEventListener('submit', function(e) {
                // ì„ íƒëœ íŒŒì¼ë“¤ì„ formDataì— ì¶”ê°€
                qnaSelectedFiles.forEach(file => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.name = 'files';
                    input.style.display = 'none';

                    // FileList ê°ì²´ ìƒì„±
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;

                    this.appendChild(input);
                });

                // í¼ì´ ì •ìƒì ìœ¼ë¡œ ì œì¶œë˜ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                this.removeEventListener('submit', arguments.callee);
            });
        }

        // í†µí•© ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ (ê¸°ì¡´ QnAìš© - í˜¸í™˜ì„± ìœ ì§€)
        window.previewImages = function (input, previewId) {
            handleImagePreview(input, previewId, 'img-thumbnail me-2', '100px');
        };

        // ê³µí†µ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬ í•¨ìˆ˜
        function handleImagePreview(input, previewId, className, maxSize) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';

            if (input.files.length > 4) {
                alert("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 4ì¥ê¹Œì§€ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                input.value = '';
                return;
            }

            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = className;
                    img.style.maxHeight = maxSize;
                    if (maxSize === '150px') {
                        img.style.width = '150px';
                    }
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        // QnA ë‹µë³€ ì‘ì„± í¼ í† ê¸€ í•¨ìˆ˜
        window.toggleAnswerForm = function(qnaId) {
            const form = document.getElementById('answerForm_' + qnaId);
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        };

        // QnA ë‹µë³€ ìˆ˜ì • í¼ í† ê¸€ í•¨ìˆ˜
        window.toggleAnswerEditForm = function(qnaId) {
            const form = document.getElementById('answerEditForm_' + qnaId);
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        };

        // QnA ì§ˆë¬¸ ìˆ˜ì • í¼ í† ê¸€ í•¨ìˆ˜
        window.toggleQnaEditForm = function(qnaId) {
            const form = document.getElementById('qnaEditForm_' + qnaId);
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        };

        // ë¦¬ë·° ìˆ˜ì • í¼ í† ê¸€ í•¨ìˆ˜
        window.toggleReviewEditForm = function(reviewId) {
            const form = document.getElementById('reviewEditForm_' + reviewId);
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        };



        // ë¦¬ë·° ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
        const reviewImageInput = document.getElementById('reviewImageInput');
        const reviewPreviewContainer = document.getElementById('reviewPreviewContainer');

        if (reviewImageInput && reviewPreviewContainer) {
            reviewImageInput.addEventListener('change', function() {
                reviewPreviewContainer.innerHTML = '';

                if (this.files.length > 4) {
                    alert("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 4ì¥ê¹Œì§€ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    this.value = '';
                    return;
                }

                Array.from(this.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const box = document.createElement('div');
                        box.className = 'img-box';
                        box.style.display = 'inline-block';
                        box.style.margin = '10px';
                        box.style.position = 'relative';

                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '150px';
                        img.style.height = 'auto';
                        img.style.border = '1px solid #ccc';
                        img.style.borderRadius = '12px';

                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerText = 'X';
                        deleteBtn.style.position = 'absolute';
                        deleteBtn.style.top = '5px';
                        deleteBtn.style.right = '5px';
                        deleteBtn.style.background = 'red';
                        deleteBtn.style.color = 'white';
                        deleteBtn.style.border = 'none';
                        deleteBtn.style.borderRadius = '50%';
                        deleteBtn.style.width = '20px';
                        deleteBtn.style.height = '20px';
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.onclick = function() {
                            // íŒŒì¼ ì‚­ì œë¥¼ ìœ„í•´ inputì˜ filesë¥¼ ì¡°ì‘
                            const dt = new DataTransfer();
                            const files = Array.from(reviewImageInput.files);
                            files.splice(index, 1);
                            files.forEach(file => dt.items.add(file));
                            reviewImageInput.files = dt.files;

                            // ë¯¸ë¦¬ë³´ê¸°ì—ì„œë„ ì œê±°
                            box.remove();
                        };

                        box.appendChild(img);
                        box.appendChild(deleteBtn);
                        reviewPreviewContainer.appendChild(box);
                    };
                    reader.readAsDataURL(file);
                });
            });
        }
    });
</script>

</body>
</html>